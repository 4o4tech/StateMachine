var StateMachine=function(a){if(this._isEmptyObj(a))throw Error("\u8bf7\u6b63\u786e\u8bbe\u7f6e\u72b6\u6001\uff01");this._events={};this._states=a;this._initStates=this._cloneStates()};StateMachine.prototype.reset=function(){for(var a in this._initStates)this._states[a]=this._initStates[a]};StateMachine.prototype.set=function(a,b){var d=this._cloneStates(),e;if("object"==typeof a)for(e in a)this._states[e]=a[e];this._states[a]=b;return this._check(d)};
StateMachine.prototype.get=function(a){var b=this._cloneStates();return arguments.length?b(a):b};StateMachine.prototype.on=function(a,b,d){"function"==typeof a&&(d=b,b=a,a="default");this._events[a]||(this._events[a]=[]);this._events[a].push({handler:b,conditions:d})};
StateMachine.prototype.off=function(a,b){0==arguments.length?this._events={}:"function"==typeof a?this._offByHandler(a):this._events[a]&&("function"!=typeof b?delete this._events[a]:this._events[a].filter(function(a){return a.handler!==b}))};StateMachine.prototype._offByHandler=function(a){for(var b in this._events)this._events[b].filter(function(b){return b.handler!==a})};
StateMachine.prototype.trigger=function(a,b){if(0==arguments.length)this._triggerByHandler("*");else if("function"==typeof a)this._triggerByHandler(a);else if(this._events[a]){var d=this._cloneStates();this._events[a].forEach(function(e){e.handler===b&&e.handler.call(that,{name:a,handler:e.handler,from:d,to:d})})}};
StateMachine.prototype._triggerByHandler=function(a){var b=this._cloneStates(),d,e=this;for(d in this._events)this._events[d].forEach(function(c){"*"!=a&&c.handler!==a||c.handler.call(e,{name:d,handler:c.handler,from:b,to:b})})};
StateMachine.prototype._check=function(a){var b=[],d=[],e,c,f=this;for(c in this._states)a[c]!=this._states[c]&&b.push(c);if(!b.length)return!1;for(e in f._events)f._events[e].forEach(function(c){var g=!1;"function"==typeof c.conditions?g=c.conditions(a,f._cloneStates(),b):f._checkFrom(c.conditions,a,b)&&f._checkTo(c.conditions,f._states,b)&&f._change(c.conditions,f._states,b)&&f._anyChange(c.conditions,f._states,b)&&(g=!0);g&&d.push({name:e,handler:c.handler,from:a,to:f._cloneStates()})});d.forEach(function(a){a.handler.call(f,
a)});return!0};StateMachine.prototype._checkFrom=function(a,b,d){return this._isEmptyObj(a)?!0:this._checkOneCondition(a.from,b,d,b)};StateMachine.prototype._checkTo=function(a,b,d){return this._isEmptyObj(a)?!0:this._checkOneCondition(a.to,this._states,d,b)};StateMachine.prototype._change=function(a,b,d){var e=!0;if(this._isEmptyObj(a)||!Array.isArray(a.change))return!0;a.change.forEach(function(a){~d.indexOf(a)||(e=!1)});return e};
StateMachine.prototype._anyChange=function(a,b,d){var e=!1;if(this._isEmptyObj(a)||!Array.isArray(a.anyChange))return!0;a.anyChange.forEach(function(a){~d.indexOf(a)&&(e=!0)});return e};
StateMachine.prototype._checkOneCondition=function(a,b,d,e){d=this._cloneStates();if(this._isEmptyObj(a))return!0;var c=!0,f,h;for(f in a){c=a[f];h=this._getConditionType(c);switch(h){case "function":c=c(e[f],d[f]);break;case "string":case "other":c=b[f]===c;break;case "array":c=~c.indexOf(b[f]);break;case "regexp":c=c.test(b[f]);break;default:c=!1}if(!c)break}return c};
StateMachine.prototype._getConditionType=function(a){var b="other";"function"==typeof a?b="function":"string"==typeof a?b="string":"object"==typeof a&&(Array.isArray(a)?b="array":a instanceof RegExp&&(b="regexp"));return b};StateMachine.prototype._isEmptyObj=function(a){if("object"!=typeof a)return!0;for(var b in a)return!1;return!0};StateMachine.prototype._cloneStates=function(a){a={};for(var b in this._states)a[b]=this._states[b];return a};